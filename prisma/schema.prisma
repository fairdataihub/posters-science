generator client {
    provider        = "prisma-client-js"
    previewFeatures = ["strictUndefinedChecks"]
}

// generator kysely {
//   provider = "prisma-kysely"

//   output   = "../types"
//   fileName = "kysely.ts"
// }

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id String @id @default(cuid(2))

    givenName  String @default("") // first name
    familyName String @default("") // last name

    emailAddress String @unique
    password     String

    emailVerified                 Boolean   @default(false)
    emailVerifiedAt               DateTime?
    emailVerificationToken        String?   @unique
    emailVerificationTokenExpires DateTime?

    created          DateTime           @default(now())
    updated          DateTime           @updatedAt
    Poster           Poster[]
    ZenodoToken      ZenodoToken?
    ZenodoDeposition ZenodoDeposition[]
    ExtractionJob    ExtractionJob[]

    @@index([emailAddress])
}

model UserInterest {
    id String @id @default(cuid())

    emailAddress String @unique

    created DateTime @default(now())

    @@index([emailAddress])
}

model Poster {
    id Int @id @default(autoincrement())

    title       String
    description String

    imageUrl String

    status      String    @default("draft") // draft, published
    publishedAt DateTime?

    user   User   @relation(fields: [userId], references: [id])
    userId String

    randomInt Int @default(0) // a field to touch when data in a related table is updated - For sorting by last updated

    created DateTime @default(now())
    updated DateTime @updatedAt

    posterMetadata    PosterMetadata?
    zenodoDepositions ZenodoDeposition[]
    extractionJobs    ExtractionJob[]
}

model PosterMetadata {
    poster   Poster @relation(fields: [posterId], references: [id], onDelete: Cascade)
    posterId Int    @id

    doi String?

    identifiers          Json @default("[]") // [{ identifier: string, identifierType: string }]
    alternateIdentifiers Json @default("[]") // [{ identifier: string, identifierType: string }]

    creators Json @default("[]") // [{ name: string, nameType: string, nameIdentifiers: [{ nameIdentifier: string, nameIdentifierScheme: string, schemeURI: string }], affiliation: [{ name: string, affiliationIdentifier: string, affiliationIdentifierScheme: string, schemeURI: string }] }]

    titles       Json @default("[]") // [{ title: string, titleType: string }]
    descriptions Json @default("[]") // [{ description: string, descriptionType: string }]

    publisher       Json @default("[]") // [{ name: string, publisherIdentifier: string, publisherIdentifierScheme: string, schemeURI: string }]
    publicationYear Int?

    subjects Json @default("[]") // [{ subject: string, schemeUri: string, valueUri: string, subjectScheme: string, classificationCode: string }]

    dates Json @default("[]") // [{ date: string, dateType: string, dateInformation: string }]

    language String?

    types Json @default("[]") // [{ type: string, typeGeneral: string }]

    relatedIdentifiers Json @default("[]") // [{ relatedIdentifier: string, relatedIdentifierType: string, relationType: string, relatedMetadataScheme: string, schemeURI: string, schemeType: string, resourceTypeGeneral: string }]

    sizes String[] @default([])

    formats String[] @default([])

    version String?

    rightsList Json @default("[]") // [{ rights: string, rightsUri: string, rightsIdentifier: string, rightsIdentifierScheme: string, schemeUri: string }]

    fundingReferences Json @default("[]") // [{ funderName: string, funderIdentifier: string, funderIdentifierType: string, schemeUri: string, awardNumber: string, awardUri: string, awardTitle: string }]

    ethicsApproval Json @default("[]") // [{ ethicsApprovalID: string, ethicsApprovalBody: string, ethicsApprovalStatus: string, ethicsApprovalLink: string }]

    conferenceName           String?
    conferenceLocation       String?
    conferenceUri            String?
    conferenceIdentifier     String?
    conferenceIdentifierType String?
    conferenceSchemaUri      String?
    conferenceStartDate      String?
    conferenceEndDate        String?
    conferenceAcronym        String?
    conferenceSeries         String?

    posterContent Json @default("[]") // { sections: [{ sectionTitle: string, sectionContent: string }], unstructuredContent }
    tableCaption  Json @default("[]") // [{ caption1: string, caption2: string, ... }]
    imageCaption  Json @default("[]") // [{ caption1: string, caption2: string, ... }]

    domain String?

    created DateTime @default(now())
    updated DateTime @updatedAt
}

model ZenodoToken {
    id String @id @default(cuid())

    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId String @unique

    accessToken  String
    refreshToken String
    expiresAt    DateTime

    created DateTime @default(now())
    updated DateTime @updatedAt

    @@index([userId])
}

model ZenodoDeposition {
    user                   User?    @relation(fields: [userId], references: [id])
    userId                 String?
    id                     Int      @id @default(autoincrement())
    depositionId           Int      @unique // Last published Zenodo deposition ID
    status                 String   @default("unpublished") // draft, submitted, done, error
    created                DateTime @default(now())
    updated                DateTime @updatedAt
    lastPublishedZenodoDoi String? // Last published Zenodo DOI
    posterId               Int
    poster                 Poster   @relation(fields: [posterId], references: [id], onDelete: Cascade)
}

// Tracks background poster extraction jobs
// Status flow: pending -> processing -> completed/failed
model ExtractionJob {
    id String @id @default(cuid())

    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId String

    status String @default("pending") // pending, processing, completed, failed

    // Filled when job completes successfully
    posterId Int?
    poster   Poster? @relation(fields: [posterId], references: [id], onDelete: SetNull)

    // Filled when job fails
    error String?

    created DateTime @default(now())
    updated DateTime @updatedAt

    @@index([userId])
    @@index([status])
}
